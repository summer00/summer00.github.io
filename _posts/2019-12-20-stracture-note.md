---
title:  "从零开始学架构--读书笔记"
date:   2019-12-20 12:00:00 +0800
categories: [note]
---

本篇为我阅读[《从零开始学架构》](https://book.douban.com/subject/33425123/)的读书笔记。如觉得有帮助，请购买正版图书学习。

# 高性能存储

## 关系型数据库

### 读写分离

* 主从模式（一主多从，多主多从），数据写如主库，从库复制主库数据，分担读压力。
* 问题
  * 延迟：主从复制需要时间，可能造成延迟。解决方法：
    1. 写操作后的读，发送给主库
    2. 从库读取不到时，读取主库（二次读取）
    3. 关键业务（延迟要求低业务）全部从主库读取，非关键业务从库读取
  * 数据还是单机存储，当数据越来越多时，读写性能下降，备份话的时间更长，极端情况下丢失风险越大 
    * 分库

### 业务分库

* 按照业务模块将数据分散到不同的数据库
* 问题：
  * join：原本可以通过join得到的结果，需要更复杂的实现（先查询id，再根据id查询内容）
  * 事务：不同数据库中的表，可能在同一个操作中被修改（MySQL分布式事务解决方案：XA）
  * 成本：需要更多机器支持分库，因此是否分库需要正确评估

### 分表

* 垂直分表：将原本一张表的内容写入多张表中，加快单表读写性能，读取完整数据可能更复杂
* 水平分表：将一张表（千万级别）的数据存储于多张表中，问题：
  * 路由：水平分表后，需要确定一条数据属于哪个子表，需增加路由算法。常见的路由有：范围，hash，配置
  * join：需要在业务代码或数据库中间件中进行多次join查询，然后合并结果
  * count：多次count，或使用计数表（可能造成数据不一致，增加写压力）
  * group by：需要在业务代码或数据库中间件中进行排序

## NoSQL

### K-V存储（Redis为例）

支持`string, hash, list, set, zset, map`

缺点：不完全支持ACID
* 原子性：事务支持不完善
* 一致性：事务支持不完善
* 独立性：单线程，事务过大会阻塞
* 持久性：RDB和AOF

### 文档数据库

为了解决schema带来的问题，最大的特点是灵活无schema，大部分使用json存储数据。适合与电商游戏等场景。可作为关系型数据库的补充。

优势：
* 新增字段简单
* 历史数据不会出错
* 可以很容易存储复杂数据

缺点：
* 不支持事务
* join麻烦